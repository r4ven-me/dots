#########################
### TMUX CLI COMMANDS ###
#########################

## Reload settings command                      tmux source ~/.config/tmux/tmux.conf
## Join to openned session                      tmux attach -t session_name
## Kill all process of tmux                     pkill -f tmux
## Install specified plugins                    prefix + I
## Run command at startup (add to tmux.conf)    run-shell "~/your/command.sh"

########################
### GENERAL SETTINGS ###
########################

set-option -g default-terminal "screen-256color"
#set -g default-terminal 'xterm-256color' # Sets default terminal
set -ga terminal-overrides ',*:Tc' # For 256 color (enable TrueColors)
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q' # For cursor shape
set -g base-index 1 # Sets index of session
set -g pane-base-index 1 # Sets index for windows 
set -g aggressive-resize on # Enable autoresize
set -g history-limit 10000 # Sets limit of scrolling
set -g set-titles on # Enable title of windows
set -g mouse on # Enable mouse
set -g mode-style "fg=black,bg=blue" # Sets text selection color
set -g status-position top # Status bar position
set -g default-shell /usr/bin/zsh # Sets default shell
set -g default-command /usr/bin/zsh # Sets default shell command
set -g mode-keys vi # Enable vi keys in copy mode
set -g status-keys vi # Sets vi keys for command prompt
set -g @shell_mode 'vi'
set-environment -g LC_CTYPE "ru_RU.UTF-8" # Sets ru encoding env
#set -g pane-active-border-style fg=blue # Sets active board color: example with bg 'fg=blue,bg=green'
#set -s set-clipboard off # Clipboard mode on|off|external
#set -g display-time 100 # Set deley after changing focus of pane (def 750 ms)

## Extra status bar line
#setw -g pane-border-status bottom # Border placement
#setw -g pane-border-format 'â”€' # Border style

#########################
### MOUSE KEYBINDINGS ###
#########################

## Double click on window list opens new window
bind-key -n DoubleClick1Status new-window

## Middle click to paste from the clipboard (xclip pkg must be installed)
unbind-key MouseDown2Pane
bind-key -n MouseDown2Pane run "tmux set-buffer \"$(xclip -o -sel clipboard)\"; tmux paste-buffer"

## Copy but do not clear the selection
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection-no-clear
bind -T copy-mode-vi MouseDown1Pane select-pane \; send-keys -X clear-selection

## Mouse middle click cancel copy mode and paste from buffer
bind-key -T copy-mode-vi MouseDown2Pane send -X cancel \; run "tmux paste-buffer"

############################
### KEYBOARD KEYBINDINGS ###
############################

## Binds "v" and "y" keys to select and yank in copy mode
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

## VI keys for panes navigate
bind-key -r -T prefix h select-pane -L
bind-key -r -T prefix j select-pane -D
bind-key -r -T prefix k select-pane -U
bind-key -r -T prefix l select-pane -R

## VI keys for resize panes
bind-key -r -T prefix H resize-pane -L 2
bind-key -r -T prefix J resize-pane -D 2
bind-key -r -T prefix K resize-pane -U 2
bind-key -r -T prefix L resize-pane -R 2

## Binds Prefix+F5 keys to manually save tmux invironment
bind-key -T prefix F5 run-shell '~/.config/tmux/plugins/tmux-resurrect/scripts/save.sh && mv -f $(find ~/.local/share/tmux/resurrect -type f -name "tmux_resurrect_*.txt" -size +0c | sort | tail -1) ~/.local/share/tmux/resurrect/main.txt && tmux display-message "Environment saved manually!"'
## Binds Prefix+F6 keys to restore last manually saved tmux environment
bind-key -T prefix F6 run-shell 'ln -sf ~/.local/share/tmux/resurrect/main.txt ~/.local/share/tmux/resurrect/last && ~/.config/tmux/plugins/tmux-resurrect/scripts/restore.sh'

######################
### PLUGINS CONFIG ###
######################

## tmux-resurrect
# Remove session files older than 3 days
run-shell 'find ~/.local/share/tmux/resurrect/ -type f -name "*.txt" ! -name "main.txt" -mtime +3 -delete'
#set -g @resurrect-capture-pane-contents 'on' # Restores contents
set -g @resurrect-strategy-nvim 'session' # Restores neovim sessions
set -g @resurrect-processes 'ssh ranger mc tmux cmatrix ipython' # List of programms, which must be restored

## tmux-continuum
set -g @continuum-boot 'on' # Automatic Tmux starts via systemd
set -g @continuum-restore 'on' # Sets automatic restore tmux env
set -g @continuum-save-interval '60' # Sets save interval to 60 mins

####################
### PLUGINS LIST ###
####################

## List of plugins
set -g @plugin 'tmux-plugins/tpm' # Plugins manager
set -g @plugin 'tmux-plugins/tmux-sensible' # Optimal tmux default settings
set -g @plugin 'arcticicestudio/nord-tmux' # Nord theme for tmux
set -g @plugin 'tmux-plugins/tmux-resurrect' # Save and restore tmux env
set -g @plugin 'tmux-plugins/tmux-continuum' # Automates save and restore actions of tmux-resurrect

## Autoinstall TPM and plugins on new machine
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

## Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
